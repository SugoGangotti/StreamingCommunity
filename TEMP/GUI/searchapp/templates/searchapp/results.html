{% extends "searchapp/base.html" %}
{% load static %}

{% block title %}{{ query }} - Risultati{% endblock %}

{% block content %}
<div class="py-8 sm:py-12 animate-fade-in">
  
  <!-- Header -->
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6 mb-10">
      <div>
      <div class="flex items-center gap-3 mb-3">
        <button 
          onclick="window.history.back()" 
          class="p-2 hover:bg-white/10 rounded-lg transition-colors"
        >
          <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h1 class="text-3xl sm:text-4xl font-bold text-white">
          Risultati per "<span class="text-red-500">{{ query|default:'la ricerca' }}</span>"
        </h1>
      </div>
      <p id="results-count" class="text-gray-400 ml-14">
        {{ results|length }} titoli trovati
      </p>

      <!-- Filter Controls -->
      <div class="mt-4 ml-14">
        <div class="inline-flex rounded-md bg-black/30 p-1">
          <button id="filter-all" onclick="filterResults('all')" class="px-3 py-1 text-sm font-semibold text-white">Tutti</button>
          <button id="filter-movies" onclick="filterResults('movie')" class="px-3 py-1 text-sm font-medium text-gray-300 hover:text-white">Film</button>
          <button id="filter-series" onclick="filterResults('series')" class="px-3 py-1 text-sm font-medium text-gray-300 hover:text-white">Serie</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Grid - Netflix Style -->
  {% if results %}
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4">
    {% for result in results %}
    <div class="group relative card-hover cursor-pointer" data-type="{% if result.is_movie %}movie{% else %}series{% endif %}">
      <!-- Card Container -->
      <div class="relative aspect-[2/3] rounded-lg overflow-hidden bg-gray-900">
        <!-- Poster Image -->
        <img 
          src="{{ result.bg_image_url }}" 
          alt="{{ result.display_title }}" 
          class="w-full h-full object-cover"
          loading="lazy"
        >
        
        <!-- Gradient Overlay -->
        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent opacity-60 group-hover:opacity-80 transition-opacity"></div>
        
        <!-- Top Badges -->
        <div class="absolute top-2 left-2 right-2 flex items-start justify-between gap-2 z-10">
          <span class="px-2 py-1 bg-red-600 text-white text-[10px] font-bold uppercase tracking-wider rounded shadow-lg">
            {{ result.display_type }}
          </span>
          {% if result.display_release %}
          <span class="px-2 py-1 bg-black/80 backdrop-blur-sm text-white text-[10px] font-semibold rounded">
            {{ result.display_release }}
          </span>
          {% endif %}
        </div>

        <!-- Hover Content -->
        <div class="absolute inset-0 flex flex-col justify-end p-4 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-4 group-hover:translate-y-0">
          <!-- Title -->
          <h3 class="text-white font-bold text-sm mb-3 line-clamp-2 drop-shadow-lg">
            {{ result.display_title }}
          </h3>
          
          <!-- Action Buttons -->
          <div class="flex gap-2">
            {% if result.is_movie %}
            <!-- Download Movie Button -->
            <form action="{% url 'start_download' %}" method="post" class="flex-1">
              {% csrf_token %}
              <input type="hidden" name="source_alias" value="{{ result.source_alias }}">
              <input type="hidden" name="item_payload" value='{{ result.payload_json|safe }}'>
              <button 
                type="submit" 
                class="w-full py-2.5 bg-white hover:bg-gray-200 text-black font-bold text-xs rounded-md transition-all flex items-center justify-center gap-2 shadow-xl"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                Scarica
              </button>
            </form>
            {% else %}
            <!-- View Episodes Button -->
            <a 
              href="{% url 'series_detail' %}?source_alias={{ result.source_alias }}&item_payload={{ result.payload_json|urlencode }}" 
              class="flex-1 py-2.5 bg-white hover:bg-gray-200 text-black font-bold text-xs rounded-md transition-all flex items-center justify-center gap-2 shadow-xl"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Episodi
            </a>
            {% endif %}
            
            <!-- Info Button -->
            <button 
              class="w-10 h-10 bg-gray-900/80 hover:bg-gray-800 backdrop-blur-sm rounded-full flex items-center justify-center transition-colors"
              title="Info"
            >
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </button>
          </div>

          <!-- Source Badge -->
          <div class="mt-2 text-[10px] text-gray-400 font-semibold uppercase tracking-wider">
            {{ result.source }}
          </div>
        </div>
      </div>

      <!-- Bottom Info (Always Visible) -->
      <div class="mt-2 px-1">
        <h4 class="text-sm font-semibold text-gray-300 truncate group-hover:text-white transition-colors">
          {{ result.display_title }}
        </h4>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  
  <!-- Empty State -->
  <div class="flex flex-col items-center justify-center py-32 text-center">
    <div class="w-24 h-24 bg-gradient-to-br from-red-600/20 to-purple-600/20 rounded-full flex items-center justify-center mb-8">
      <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
    <h2 class="text-3xl font-bold text-white mb-4">
      Nessun risultato trovato
    </h2>
    <p class="text-gray-400 text-lg mb-8 max-w-md">
      Prova a modificare i termini di ricerca o seleziona una sorgente diversa
    </p>
    <a 
      href="{% url 'search_home' %}" 
      class="inline-flex items-center gap-2 px-8 py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-md transition-all transform hover:scale-105 shadow-xl"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Torna alla Ricerca
    </a>
  </div>
  {% endif %}
</div>

<style>
  /* Line clamp utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Enhanced card hover - Netflix style */
  @media (min-width: 768px) {
    .card-hover:hover {
      transform: scale(1.15);
      z-index: 20;
    }
  }
</style>
<script>
  function filterResults(filter) {
    const cards = document.querySelectorAll('.group.card-hover[data-type]');
    let visible = 0;
    cards.forEach(card => {
      const type = card.dataset.type;
      if (filter === 'all' || type === filter) {
        card.style.display = '';
        visible++;
      } else {
        card.style.display = 'none';
      }
    });

    const countEl = document.getElementById('results-count');
    if (countEl) {
      countEl.textContent = `${visible} titoli trovati`;
    }

    // Update active button styles
    ['filter-all','filter-movies','filter-series'].forEach(id => {
      const btn = document.getElementById(id);
      if (!btn) return;
      if ((filter === 'all' && id === 'filter-all') || (filter === 'movie' && id === 'filter-movies') || (filter === 'series' && id === 'filter-series')) {
        btn.classList.remove('text-gray-300','font-medium');
        btn.classList.add('text-white','font-semibold');
      } else {
        btn.classList.remove('text-white','font-semibold');
        btn.classList.add('text-gray-300','font-medium');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    filterResults('all');
  });
</script>
{% endblock %}